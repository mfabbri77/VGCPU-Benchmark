implementation_checklist:
  blueprint_version: "1.1"
  repo_name: "VGCPU-Benchmark"

  milestones:
    - id: "MS-01"
      name: "Vendor deps + build wiring for PNG/SSIM"
      steps:
        - id: "TASK-01.01"
          action: "Vendor stb_image_write and SSIM single-file implementation under third_party/ with provenance headers; update THIRD_PARTY_NOTICES.md"
          refs: ["CR-0002", "REQ-149", "REQ-152", "BUILD-02", "BUILD-03", "DEC-BUILD-20", "DEC-BUILD-21"]
          artifacts:
            - "third_party/stb/stb_image_write.h"
            - "third_party/ssim_lomont/ssim_lomont.hpp"
            - "THIRD_PARTY_NOTICES.md"
          verify:
            - "cmake --preset dev"
            - "cmake --build --preset dev"

        - id: "TASK-01.02"
          action: "Add artifacts module target (vgcpu_artifacts) and wire it into the harness/app; add stb implementation TU with STB_IMAGE_WRITE_IMPLEMENTATION defined exactly once"
          refs: ["CR-0002", "REQ-148", "REQ-149", "BUILD-04", "DEC-BUILD-22", "DEC-BUILD-20"]
          artifacts:
            - "src/artifacts/stb_image_write_impl.cpp"
            - "src/artifacts/png_writer.cpp"
            - "src/artifacts/ssim_compare.cpp"
            - "src/artifacts/naming.cpp"
            - "CMakeLists.txt"
            - "cmake/vgcpu_deps.cmake"
          verify:
            - "cmake --preset dev"
            - "cmake --build --preset dev"

        - id: "TASK-01.03"
          action: "Implement and enable CI-grade third_party SHA-256 verification (VGCPU_VERIFY_THIRD_PARTY_HASHES) and record expected hashes in CMake"
          refs: ["CR-0002", "REQ-155", "TEST-70", "DEC-TOOL-08", "BUILD-04-04", "VER-16-01"]
          artifacts:
            - "cmake/vgcpu_deps.cmake"
            - "cmake/vgcpu_third_party_hashes.cmake"
            - "CMakePresets.json"
          verify:
            - "cmake --preset ci -DVGCPU_VERIFY_THIRD_PARTY_HASHES=ON"
            - "cmake --build --preset ci"

    - id: "MS-02"
      name: "Implement internal artifacts APIs (naming, PNG, SSIM)"
      steps:
        - id: "TASK-02.01"
          action: "Add internal headers for artifact naming, PNG writing, SSIM compare, and image view helpers under include/vgcpu/internal/artifacts/"
          refs: ["CR-0002", "API-20", "API-21", "API-22", "API-23", "API-24", "DEC-ARCH-01"]
          artifacts:
            - "include/vgcpu/internal/artifacts/naming.h"
            - "include/vgcpu/internal/artifacts/png_writer.h"
            - "include/vgcpu/internal/artifacts/ssim.h"
            - "include/vgcpu/internal/artifacts/image_view.h"
          verify:
            - "cmake --build --preset dev"

        - id: "TASK-02.02"
          action: "Implement deterministic sanitize+path construction (SanitizeName, MakePngPath) matching <output_dir>/png/<scene>_<backend>.png"
          refs: ["CR-0002", "REQ-148", "DEC-SCOPE-05", "MEM-10-04", "API-22", "API-23", "TEST-53-01"]
          artifacts:
            - "src/artifacts/naming.cpp"
            - "tests/test_artifact_naming.cpp"
          verify:
            - "cmake --build --preset dev"
            - "ctest --preset dev --output-on-failure -R artifact_naming"

        - id: "TASK-02.03"
          action: "Implement PNG writer using stb_image_write with fail-fast behavior on I/O/encode errors"
          refs: ["CR-0002", "REQ-149", "API-20", "DEC-ARCH-15", "TEST-53-02"]
          artifacts:
            - "src/artifacts/png_writer.cpp"
            - "src/artifacts/stb_image_write_impl.cpp"
            - "tests/test_png_writer.cpp"
          verify:
            - "cmake --build --preset dev"
            - "ctest --preset dev --output-on-failure -R png_writer"

        - id: "TASK-02.04"
          action: "Implement SSIM wrapper computing per-channel SSIM on premultiplied RGBA and deterministic aggregate mean"
          refs: ["CR-0002", "REQ-151", "REQ-152", "API-21", "DEC-MEM-11", "DEC-API-08", "TEST-53-03"]
          artifacts:
            - "src/artifacts/ssim_compare.cpp"
            - "tests/test_ssim.cpp"
          verify:
            - "cmake --build --preset dev"
            - "ctest --preset dev --output-on-failure -R ssim"

    - id: "MS-03"
      name: "CLI + harness + reporting integration (post-benchmark PNG + SSIM)"
      steps:
        - id: "TASK-03.01"
          action: "Extend CLI options and validation: --png, --compare-ssim, --ground-truth-backend, --ssim-threshold; enforce SSIM implies PNG and validate GT availability"
          refs: ["CR-0002", "REQ-150", "REQ-153", "REQ-154", "API-03", "DEC-API-07", "DEC-ARCH-12", "TEST-54-01", "TEST-54-02", "TEST-54-03"]
          artifacts:
            - "src/cli/cli_parser.h"
            - "src/cli/cli_parser.cpp"
            - "src/cli/main.cpp"
            - "tests/test_cli_ssim_flags.cpp"
          verify:
            - "cmake --build --preset dev"
            - "ctest --preset dev --output-on-failure -R cli_ssim"

        - id: "TASK-03.02"
          action: "Integrate post-benchmark render phase for PNG artifacts (untimed) ensuring no artifact work runs in measured loop"
          refs: ["CR-0002", "REQ-148", "REQ-149", "DEC-ARCH-11", "MEM-09-01", "TEST-55-04", "TEST-53-04"]
          artifacts:
            - "src/harness/harness.cpp"
            - "src/harness/harness.h"
            - "tests/test_harness_artifacts_phase.cpp"
          verify:
            - "cmake --build --preset dev"
            - "ctest --preset dev --output-on-failure -R harness_artifacts_phase"

        - id: "TASK-03.03"
          action: "Implement SSIM comparison phase: per-scene ground-truth-first ordering, GT buffer retention, SSIM compute for other backends, and exit-code 4 on threshold failure"
          refs: ["CR-0002", "REQ-151", "REQ-153", "REQ-154", "ARCH-04-02", "DEC-ARCH-12", "DEC-ARCH-14", "API-02-04", "TEST-56-01", "TEST-72-03"]
          artifacts:
            - "src/harness/harness.cpp"
            - "src/harness/harness.h"
            - "tests/test_harness_ssim_ordering.cpp"
            - "tests/test_ssim_exit_code.cpp"
          verify:
            - "cmake --build --preset dev"
            - "ctest --preset dev --output-on-failure -R ssim_ordering"
            - "ctest --preset dev --output-on-failure -R ssim_exit_code"

        - id: "TASK-03.04"
          action: "Extend JSON/CSV reporting schema to include png_path and SSIM metadata and bump schema_version markers"
          refs: ["CR-0002", "API-07", "DEC-SCOPE-03", "VER-15-01", "TEST-72-01"]
          artifacts:
            - "src/reporting/json_reporter.cpp"
            - "src/reporting/csv_reporter.cpp"
            - "tests/test_report_schema_version.cpp"
          verify:
            - "cmake --build --preset dev"
            - "ctest --preset dev --output-on-failure -R report_schema"

    - id: "MS-04"
      name: "Concurrency safety + sanitizers + CI coverage"
      steps:
        - id: "TASK-04.01"
          action: "Serialize artifact I/O (directory creation + PNG writes) and ensure no mutex is held while calling backend Render()"
          refs: ["CR-0002", "DEC-CONC-08", "CONC-07-02", "CONC-03-02", "API-09-01", "TEST-56-02"]
          artifacts:
            - "src/harness/harness.cpp"
            - "src/artifacts/png_writer.cpp"
            - "tests/test_artifact_io_serialization.cpp"
          verify:
            - "cmake --build --preset dev"
            - "ctest --preset dev --output-on-failure -R artifact_io_serialization"

        - id: "TASK-04.02"
          action: "Add/enable ASan/UBSan/TSan test coverage for an SSIM-enabled run path using presets"
          refs: ["CR-0002", "TOOL-03-01", "CONC-08-01", "TEST-71-02", "TEST-56-04"]
          artifacts:
            - "CMakePresets.json"
            - ".github/workflows/ci.yml"
          verify:
            - "cmake --preset asan"
            - "cmake --build --preset asan"
            - "ctest --preset asan --output-on-failure"
            - "cmake --preset tsan"
            - "cmake --build --preset tsan"
            - "ctest --preset tsan --output-on-failure"

        - id: "TASK-04.03"
          action: "Ensure third_party hash verification runs in CI and fails on mismatch when VGCPU_VERIFY_THIRD_PARTY_HASHES=ON"
          refs: ["CR-0002", "REQ-155", "TEST-70", "TEST-71-01", "DEC-TOOL-08"]
          artifacts:
            - ".github/workflows/ci.yml"
          verify:
            - "cmake --preset ci -DVGCPU_VERIFY_THIRD_PARTY_HASHES=ON"
            - "cmake --build --preset ci"
            - "ctest --preset ci --output-on-failure"

    - id: "MS-05"
      name: "Docs + version bump + release readiness"
      steps:
        - id: "TASK-05.01"
          action: "Update README/help text with new flags and clarify that --compare-ssim implies PNG artifacts; document output naming and examples"
          refs: ["CR-0002", "REQ-150", "REQ-153", "REQ-154", "DEC-SCOPE-05", "DEC-API-07"]
          artifacts:
            - "README.md"
            - "docs/QUICKSTART.md"
          verify:
            - "cmake --build --preset dev"
            - "vgcpu-benchmark --help"

        - id: "TASK-05.02"
          action: "Bump product version to 0.2.0 and add changelog/migration notes for schema changes"
          refs: ["CR-0002", "DEC-VER-01", "VER-15-02", "TEST-72-01"]
          artifacts:
            - "CMakeLists.txt"
            - "CHANGELOG.md"
            - "docs/MIGRATION_v0.2.0.md"
          verify:
            - "cmake --preset release"
            - "cmake --build --preset release"

        - id: "TASK-05.03"
          action: "Add a smoke run script/CI step that runs SSIM compare on a small scene subset and retains png/ reports on failure"
          refs: ["CR-0002", "VER-14-02", "DEC-VER-07", "API-02-04"]
          artifacts:
            - ".github/workflows/ci.yml"
            - "tools/ci_smoke_ssim.sh"
          verify:
            - "cmake --preset ci"
            - "cmake --build --preset ci"
            - "tools/ci_smoke_ssim.sh"

  quality_gates:
    - id: "GATE-01"
      name: "Format check"
      command: "cmake --build --preset ci --target format_check"
      refs: ["TOOL-01-01", "DEC-TOOL-01"]

    - id: "GATE-02"
      name: "No TEMP-DBG markers"
      command: "cmake --build --preset ci --target check_no_temp_dbg"
      refs: ["TEMP-DBG", "DEC-TOOL-04"]

    - id: "GATE-03"
      name: "Unit + integration tests (CI preset)"
      command: "ctest --preset ci --output-on-failure"
      refs: ["TEST-53", "TEST-54", "TEST-55", "TEST-56", "TEST-72"]

    - id: "GATE-04"
      name: "ASan/UBSan/TSan sanitized tests"
      command: "ctest --preset asan --output-on-failure && ctest --preset ubsan --output-on-failure && ctest --preset tsan --output-on-failure"
      refs: ["TOOL-03-01", "CONC-08-01", "TEST-71-02"]

    - id: "GATE-05"
      name: "Vendored third_party hash verification"
      command: "cmake --preset ci -DVGCPU_VERIFY_THIRD_PARTY_HASHES=ON && cmake --build --preset ci"
      refs: ["REQ-155", "TEST-70", "DEC-TOOL-08"]

  release:
    tagging: "v0.2.0"
    required_files:
      - "CHANGELOG.md"
      - "THIRD_PARTY_NOTICES.md"
      - "docs/MIGRATION_v0.2.0.md"
      - "README.md"
    required_gates: ["GATE-01", "GATE-02", "GATE-03", "GATE-04", "GATE-05"]
    build_artifacts:
      - name: "vgcpu-benchmark (release build)"
        command: "cmake --preset release && cmake --build --preset release"
        outputs:
          - "build/release/vgcpu-benchmark"
          - "build/release/vgcpu-benchmark.exe"
      - name: "CI SSIM smoke artifacts"
        command: "tools/ci_smoke_ssim.sh"
        outputs:
          - "<output_dir>/results.json"
          - "<output_dir>/results.csv"
          - "<output_dir>/png/*.png"
```
